<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>George's –°—É–≤–µ–Ω–∏—Ä—ã</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --accent: #ff85a2;
      --accent-soft: #fbb6ce;
      --bg-gradient: linear-gradient(135deg, #fff5f7 0%, #f0efff 100%);
      --card-bg: rgba(255, 255, 255, 0.9);
      --text: #5c4d61;
      --shadow: 0 10px 25px rgba(255, 133, 162, 0.15);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Comfortaa', cursive; background: var(--bg-gradient); background-attachment: fixed; color: var(--text); margin: 0; padding: 15px; min-height: 100vh; }
    .container { max-width: 500px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 26px; color: #d63384; margin: 10px 0; }

    .btn-glass { background: var(--card-bg); border: 2px solid var(--accent-soft); color: var(--accent); padding: 12px; border-radius: 20px; width: 100%; font-weight: 700; margin-bottom: 15px; cursor: pointer; transition: 0.3s; }
    .btn-glass:active { transform: scale(0.96); background: var(--accent-soft); color: white; }

    .card { background: var(--card-bg); backdrop-filter: blur(10px); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); }
    form { display: grid; gap: 12px; }
    input { padding: 14px; border: 1px solid #eee; border-radius: 15px; font-family: inherit; outline: none; background: #fff; }

    .btn-add { background: linear-gradient(90deg, #ff85a2, #ff99ac); color: white; border: none; padding: 14px; border-radius: 15px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .btn-secondary { background: #fff; border: 1px solid var(--accent-soft); color: var(--accent); padding: 10px; border-radius: 12px; font-size: 12px; cursor: pointer; font-weight: 600; }

    .search-input { width: 100%; padding: 12px 15px; border-radius: 18px; border: 1px solid var(--accent-soft); outline: none; font-family: inherit; margin-bottom: 15px;}

    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
    .item-info b { font-size: 16px; display: block; }
    .item-info span { font-size: 12px; color: #999; }

    .actions { display: flex; gap: 6px; }
    .btn-circle { width: 34px; height: 34px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
    .btn-edit-mini { background: #ebf4ff; color: #3182ce; }
    .btn-sell-mini { background: #e6fffa; color: #38b2ac; }
    .btn-del-mini { background: #fff5f5; color: #feb2b2; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(92, 77, 97, 0.4); backdrop-filter: blur(5px); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: white; padding: 25px; border-radius: 30px; width: 100%; max-width: 450px; text-align: center; }

    .report-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .btn-wa { background: #25D366; color: white; border: none; }
    .btn-xl { background: #217346; color: white; border: none; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>‚ú® —É –∫–æ–º–∞–Ω–¥–∏—Ä–∞ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—é –ø–∞—Ä–æ–ª—åüê∞‚ú®</h1>
  </header>

  <button class="btn-glass" onclick="openHistory()">üìÖ –ñ—É—Ä–Ω–∞–ª –ø—Ä–æ–¥–∞–∂ & –û—Ç—á–µ—Ç—ã</button>

  <div class="card">
    <form id="itemForm">
      <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–≤–µ–Ω–∏—Ä–∞" required>
      <div style="display: flex; gap: 10px;">
        <input id="quantity" type="number" min="0" placeholder="–ö–æ–ª-–≤–æ" style="width: 40%;" required>
        <input id="price" type="number" min="0" placeholder="–¶–µ–Ω–∞ (÷è)" style="width: 60%;">
      </div>
      <button type="submit" class="btn-add">‚ú® –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </form>
  </div>

  <input type="text" id="searchInput" class="search-input" placeholder="üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä..." oninput="render()">
  <div class="card" id="itemsList"></div>
</div>

<div id="editPopup" class="modal"><div class="modal-content">
  <h3>üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
  <form id="editForm">
    <input id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
    <div style="display: flex; gap: 10px;">
      <input id="editQuantity" type="number" min="0" placeholder="–ö–æ–ª-–≤–æ" style="width: 40%;" required>
      <input id="editPrice" type="number" min="0" placeholder="–¶–µ–Ω–∞" style="width: 60%;">
    </div>
    <button type="submit" class="btn-add">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>
  <button onclick="closeModal('editPopup')" style="background:none; border:none; color:#aaa; margin-top:15px;">–û—Ç–º–µ–Ω–∞</button>
</div></div>

<div id="sellPopup" class="modal"><div class="modal-content">
  <h3 id="sellTitle">–ü—Ä–æ–¥–∞–∂–∞</h3>
  <input id="sellQty" type="number" min="1" value="1" style="width:100%; text-align:center; margin-bottom:15px; border:1px solid #eee; border-radius:15px; padding:12px;">
  <button class="btn-add" onclick="confirmSell()" style="width:100%">–°–ø–∏—Å–∞—Ç—å</button>
  <button onclick="closeModal('sellPopup')" style="background:none; border:none; color:#aaa; margin-top:15px;">–û—Ç–º–µ–Ω–∞</button>
</div></div>

<div id="historyPopup" class="modal"><div class="modal-content">
  <h3>üìä –ò—Å—Ç–æ—Ä–∏—è –∏ –û—Ç—á–µ—Ç—ã</h3>
  <input type="date" id="historyDateFilter" onchange="filterHistoryByDate()" style="margin-bottom:10px; width:100%; padding:10px; border-radius:10px; border:1px solid #eee;">
  
  <div id="historyContent" style="max-height: 250px; overflow-y: auto; text-align: left;"></div>
  
  <div style="margin-top:15px; font-weight:700; color:#d63384; font-size: 18px;">–ò—Ç–æ–≥–æ: <span id="historyTotal">0</span> ÷è</div>

  <div class="report-buttons">
    <button class="btn-secondary btn-wa" onclick="sendWhatsAppReport()">WhatsApp üí¨</button>
    <button class="btn-secondary btn-xl" onclick="exportToExcel()">Excel üìä</button>
  </div>

  <button class="btn-add" onclick="closeModal('historyPopup')" style="width:100%; margin-top:20px">–ó–∞–∫—Ä—ã—Ç—å</button>
</div></div>

<script>
let items = JSON.parse(localStorage.getItem('souvenirs_v9')) || [];
let sales = JSON.parse(localStorage.getItem('sales_v9')) || [];
let currentIdx = null;

const save = () => localStorage.setItem('souvenirs_v9', JSON.stringify(items));
const saveSales = () => localStorage.setItem('sales_v9', JSON.stringify(sales));

function render() {
  const container = document.getElementById('itemsList');
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = items.map((item, originalIndex) => ({...item, originalIndex}))
                        .filter(item => item.name.toLowerCase().includes(query));

  container.innerHTML = filtered.length ? '' : '<p style="text-align:center; color:#ccc;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>';
  filtered.forEach((item) => {
    container.innerHTML += `
      <div class="item-row">
        <div class="item-info">
          <b>${item.name}</b>
          <span>–û—Å—Ç–∞—Ç–æ–∫: ${item.quantity} —à—Ç ‚Ä¢ ${item.price} ÷è</span>
        </div>
        <div class="actions">
          <button class="btn-circle btn-edit-mini" onclick="openEdit(${item.originalIndex})">üìù</button>
          <button class="btn-circle btn-sell-mini" onclick="openSell(${item.originalIndex})">üí∏</button>
          <button class="btn-circle btn-del-mini" onclick="deleteItem(${item.originalIndex})">‚úï</button>
        </div>
      </div>`;
  });
}

function openEdit(idx) {
  currentIdx = idx;
  const item = items[idx];
  document.getElementById('editName').value = item.name;
  document.getElementById('editQuantity').value = item.quantity;
  document.getElementById('editPrice').value = item.price;
  document.getElementById('editPopup').style.display = 'flex';
}

document.getElementById('editForm').onsubmit = e => {
  e.preventDefault();
  items[currentIdx].name = document.getElementById('editName').value;
  items[currentIdx].quantity = +document.getElementById('editQuantity').value;
  items[currentIdx].price = +document.getElementById('editPrice').value;
  save(); render(); closeModal('editPopup');
};

function openSell(idx) {
  currentIdx = idx;
  document.getElementById('sellTitle').innerText = items[idx].name;
  document.getElementById('sellQty').value = 1;
  document.getElementById('sellPopup').style.display = 'flex';
}

function confirmSell() {
  const qty = +document.getElementById('sellQty').value;
  const item = items[currentIdx];
  if (qty > 0 && qty <= item.quantity) {
    const before = item.quantity;
    item.quantity -= qty;
    const now = new Date();
    sales.unshift({
      name: item.name, qty, before, after: item.quantity, total: qty * item.price,
      dateKey: now.toISOString().split('T')[0],
      dateDisplay: now.toLocaleDateString('ru-RU'),
      time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
    });
    save(); saveSales(); render(); closeModal('sellPopup');
  } else { alert('–û—à–∏–±–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞'); }
}

function openHistory() {
  document.getElementById('historyDateFilter').value = '';
  updateHistoryUI();
  document.getElementById('historyPopup').style.display = 'flex';
}

function filterHistoryByDate() { updateHistoryUI(document.getElementById('historyDateFilter').value); }

function updateHistoryUI(filterDate = null) {
  const container = document.getElementById('historyContent');
  let grandTotal = 0;
  const filteredSales = filterDate ? sales.filter(s => s.dateKey === filterDate) : sales;
  
  container.innerHTML = filteredSales.length ? '' : '<p style="text-align:center; color:#ccc; padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
  
  filteredSales.forEach(s => {
    grandTotal += s.total;
    container.innerHTML += `
      <div class="history-item">
        <div style="display:flex; justify-content:space-between"><b>${s.name}</b> <span>${s.total} ÷è</span></div>
        <div style="font-size:11px; color:#999">${s.dateDisplay} ${s.time} ‚Ä¢ –ë—ã–ª–æ: ${s.before} ‚Üí –°—Ç–∞–ª–æ: ${s.after} (${s.qty} —à—Ç)</div>
      </div>`;
  });
  document.getElementById('historyTotal').innerText = grandTotal;
}

// –≠–ö–°–ü–û–†–¢ –í WHATSAPP
function sendWhatsAppReport() {
  const filterDate = document.getElementById('historyDateFilter').value;
  const filteredSales = filterDate ? sales.filter(s => s.dateKey === filterDate) : sales;
  
  if (filteredSales.length === 0) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');

  let text = `üå∏ *–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (${filterDate || '–í—Å–µ –≤—Ä–µ–º—è'})* üå∏\n\n`;
  let total = 0;
  filteredSales.forEach(s => {
    text += `üîπ ${s.name}: ${s.qty} —à—Ç. –Ω–∞ ${s.total} ÷è\n`;
    total += s.total;
  });
  text += `\nüí∞ *–ò—Ç–æ–≥–æ: ${total} ÷è*`;
  
  const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
}

// –≠–ö–°–ü–û–†–¢ –í EXCEL
function exportToExcel() {
  const filterDate = document.getElementById('historyDateFilter').value;
  const filteredSales = filterDate ? sales.filter(s => s.dateKey === filterDate) : sales;

  if (filteredSales.length === 0) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');

  const data = filteredSales.map(s => ({
    "–î–∞—Ç–∞": s.dateDisplay,
    "–í—Ä–µ–º—è": s.time,
    "–¢–æ–≤–∞—Ä": s.name,
    "–ö–æ–ª-–≤–æ": s.qty,
    "–°—É–º–º–∞ (÷è)": s.total,
    "–ë—ã–ª–æ": s.before,
    "–°—Ç–∞–ª–æ": s.after
  }));

  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "–ü—Ä–æ–¥–∞–∂–∏");
  XLSX.writeFile(workbook, `–û—Ç—á–µ—Ç_–ü—Ä–æ–¥–∞–∂–∏_${filterDate || '–ø–æ–ª–Ω—ã–π'}.xlsx`);
}

function deleteItem(idx) { if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) { items.splice(idx, 1); save(); render(); } }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

document.getElementById('itemForm').onsubmit = e => {
  e.preventDefault();
  items.push({
    name: document.getElementById('name').value,
    quantity: +document.getElementById('quantity').value,
    price: +document.getElementById('price').value || 0
  });
  save(); render(); e.target.reset();
};

render();
</script>
</body>
</html>