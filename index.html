<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>George's –°—É–≤–µ–Ω–∏—Ä—ã ‚Äî –£—á—ë—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --accent: #ff85a2;
      --accent-soft: #fbb6ce;
      --bg-gradient: linear-gradient(135deg, #fff5f7 0%, #f0efff 100%);
      --card-bg: rgba(255, 255, 255, 0.9);
      --text: #5c4d61;
      --shadow: 0 10px 25px rgba(255, 133, 162, 0.15);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Comfortaa', cursive; background: var(--bg-gradient); background-attachment: fixed; color: var(--text); margin: 0; padding: 15px; min-height: 100vh; }
    .container { max-width: 500px; margin: 0 auto; }

    header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 22px; color: #d63384; margin: 10px 0; line-height: 1.4; }

    .btn-glass { background: var(--card-bg); border: 2px solid var(--accent-soft); color: var(--accent); padding: 12px; border-radius: 20px; width: 100%; font-weight: 700; margin-bottom: 15px; cursor: pointer; transition: 0.3s; }
    .btn-glass:active { transform: scale(0.98); background: var(--accent-soft); color: white; }

    .card { background: var(--card-bg); backdrop-filter: blur(10px); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); }
    form { display: grid; gap: 12px; }
    input { padding: 14px; border: 1px solid #eee; border-radius: 15px; font-family: inherit; outline: none; background: #fff; width: 100%; }

    .btn-add { background: linear-gradient(90deg, #ff85a2, #ff99ac); color: white; border: none; padding: 14px; border-radius: 15px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .search-input { width: 100%; padding: 12px 15px; border-radius: 18px; border: 1px solid var(--accent-soft); outline: none; font-family: inherit; margin-bottom: 15px; }

    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
    .item-info b { font-size: 15px; display: block; color: #d63384; }
    .item-info span { font-size: 12px; color: #777; font-weight: 600; }

    .actions { display: flex; gap: 8px; }
    .btn-circle { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .btn-edit-mini { background: #ebf4ff; color: #3182ce; }
    .btn-sell-mini { background: #e6fffa; color: #38b2ac; }
    .btn-del-mini { background: #fff5f5; color: #feb2b2; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: white; padding: 25px; border-radius: 30px; width: 100%; max-width: 400px; text-align: center; }

    .payment-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .pay-btn { padding: 12px; border: 2px solid #f0f0f0; border-radius: 15px; cursor: pointer; font-weight: 700; color: #ccc; }
    .pay-btn.active { border-color: var(--accent); color: var(--accent); background: #fff5f7; }

    .totals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
    .total-box { background: #fef2f2; padding: 12px; border-radius: 15px; font-size: 12px; }
    .total-box b { font-size: 14px; color: #d63384; }

    .report-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .btn-wa { background: #25D366; color: white; border: none; border-radius: 12px; padding: 10px; cursor: pointer; font-weight: 600; }
    .btn-xl { background: #217346; color: white; border: none; border-radius: 12px; padding: 10px; cursor: pointer; font-weight: 600; }
    .btn-clear { background: #fca5a5; color: white; border: none; margin-top: 20px; padding: 8px; border-radius: 10px; font-size: 11px; cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>‚ú® —É –∫–æ–º–∞–Ω–¥–∏—Ä–∞ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø–∞—Ä–æ–ª—åüê∞‚ú®</h1>
  </header>

  <button class="btn-glass" onclick="openHistory()">üìÖ –ñ—É—Ä–Ω–∞–ª –ø—Ä–æ–¥–∞–∂ & –û—Ç—á–µ—Ç—ã</button>

  <div class="card">
    <form id="itemForm">
      <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–≤–µ–Ω–∏—Ä–∞" required>
      <div style="display: flex; gap: 10px;">
        <input id="quantity" type="number" min="0" placeholder="–ö–æ–ª-–≤–æ" required>
        <input id="price" type="number" min="0" placeholder="–¶–µ–Ω–∞ (÷è)">
      </div>
      <button type="submit" class="btn-add">‚ú® –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </form>
  </div>

  <input type="text" id="searchInput" class="search-input" placeholder="üîç –ù–∞–π—Ç–∏ –≤ —Å–ø–∏—Å–∫–µ..." oninput="render()">
  <div class="card" id="itemsList"></div>
</div>

<div id="editPopup" class="modal"><div class="modal-content">
  <h3>üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h3>
  <form id="editForm">
    <input id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
    <div style="display: flex; gap: 10px;">
      <input id="editQuantity" type="number" min="0" placeholder="–ö–æ–ª-–≤–æ" required>
      <input id="editPrice" type="number" min="0" placeholder="–¶–µ–Ω–∞ (÷è)">
    </div>
    <button type="submit" class="btn-add">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
  </form>
  <button onclick="closeModal('editPopup')" style="background:none; border:none; color:#aaa; margin-top:15px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
</div></div>

<div id="sellPopup" class="modal"><div class="modal-content">
  <h3 id="sellTitle">–ü—Ä–æ–¥–∞–∂–∞</h3>
  <input id="sellQty" type="number" min="1" value="1" style="text-align:center; margin-bottom:15px; font-size: 18px;">
  <div class="payment-selector">
    <div id="payCash" class="pay-btn active" onclick="setPayment('cash')">üíµ –ù–∞–ª</div>
    <div id="payCard" class="pay-btn" onclick="setPayment('card')">üí≥ –ö–∞—Ä—Ç–∞</div>
  </div>
  <button class="btn-add" onclick="confirmSell()" style="width:100%">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  <button onclick="closeModal('sellPopup')" style="background:none; border:none; color:#aaa; margin-top:15px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
</div></div>

<div id="historyPopup" class="modal"><div class="modal-content" style="max-width: 450px;">
  <h3>üìä –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</h3>
  <input type="date" id="historyDateFilter" onchange="filterHistoryByDate()" style="margin-bottom:10px;">
  
  <div id="historyContent" style="max-height: 250px; overflow-y: auto; text-align: left; border-top: 1px solid #eee;"></div>
  
  <div class="totals-grid">
    <div class="total-box">üíµ –ù–∞–ª:<br><b id="totalCash">0</b> ÷è</div>
    <div class="total-box">üí≥ –ö–∞—Ä—Ç—ã:<br><b id="totalCard">0</b> ÷è</div>
  </div>
  <div style="font-weight:700; color:#d63384; font-size: 20px;">–ò—Ç–æ–≥–æ: <span id="historyTotal">0</span> ÷è</div>

  <div class="report-buttons">
    <button class="btn-wa" onclick="sendWhatsAppReport()">WhatsApp</button>
    <button class="btn-xl" onclick="exportToExcel()">Excel</button>
  </div>

  <button class="btn-clear" onclick="clearSalesHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
  <button class="btn-add" onclick="closeModal('historyPopup')" style="width:100%; margin-top:15px; background: #5c4d61;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div></div>

<script>
let items = JSON.parse(localStorage.getItem('george_stock_v12')) || [];
let sales = JSON.parse(localStorage.getItem('george_sales_v12')) || [];
let currentIdx = null;
let currentPayment = 'cash';

const saveAll = () => {
  localStorage.setItem('george_stock_v12', JSON.stringify(items));
  localStorage.setItem('george_sales_v12', JSON.stringify(sales));
};

function render() {
  const container = document.getElementById('itemsList');
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = items.map((item, originalIndex) => ({...item, originalIndex}))
                        .filter(item => item.name.toLowerCase().includes(query));

  container.innerHTML = filtered.length ? '' : '<p style="text-align:center; color:#ccc;">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
  filtered.forEach((item) => {
    container.innerHTML += `
      <div class="item-row">
        <div class="item-info">
          <b>${item.name}</b>
          <span>${item.quantity} —à—Ç ‚Ä¢ ${item.price} ÷è</span>
        </div>
        <div class="actions">
          <button class="btn-circle btn-edit-mini" onclick="openEdit(${item.originalIndex})">üìù</button>
          <button class="btn-circle btn-sell-mini" onclick="openSell(${item.originalIndex})">üí∏</button>
          <button class="btn-circle btn-del-mini" onclick="deleteItem(${item.originalIndex})">‚úï</button>
        </div>
      </div>`;
  });
}

// –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–û–í–ê–†–ê
function openEdit(idx) {
  currentIdx = idx;
  const item = items[idx];
  document.getElementById('editName').value = item.name;
  document.getElementById('editQuantity').value = item.quantity;
  document.getElementById('editPrice').value = item.price;
  document.getElementById('editPopup').style.display = 'flex';
}

document.getElementById('editForm').onsubmit = (e) => {
  e.preventDefault();
  items[currentIdx].name = document.getElementById('editName').value;
  items[currentIdx].quantity = parseInt(document.getElementById('editQuantity').value);
  items[currentIdx].price = parseInt(document.getElementById('editPrice').value) || 0;
  saveAll();
  render();
  closeModal('editPopup');
};

// –ü–†–û–î–ê–ñ–ê
function setPayment(type) {
  currentPayment = type;
  document.getElementById('payCash').classList.toggle('active', type === 'cash');
  document.getElementById('payCard').classList.toggle('active', type === 'card');
}

function openSell(idx) {
  currentIdx = idx;
  setPayment('cash');
  document.getElementById('sellTitle').innerText = items[idx].name;
  document.getElementById('sellQty').value = 1;
  document.getElementById('sellPopup').style.display = 'flex';
}

function confirmSell() {
  const qty = +document.getElementById('sellQty').value;
  const item = items[currentIdx];
  if (qty > 0 && qty <= item.quantity) {
    const before = item.quantity;
    item.quantity -= qty;
    const now = new Date();
    sales.unshift({
      name: item.name, qty, before, after: item.quantity, total: qty * item.price,
      payment: currentPayment,
      dateKey: now.toISOString().split('T')[0],
      dateDisplay: now.toLocaleDateString('ru-RU'),
      time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
    });
    saveAll(); render(); closeModal('sellPopup');
  } else { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞!'); }
}

// –ò–°–¢–û–†–ò–Ø
function openHistory() {
  document.getElementById('historyDateFilter').value = '';
  updateHistoryUI();
  document.getElementById('historyPopup').style.display = 'flex';
}

function filterHistoryByDate() { updateHistoryUI(document.getElementById('historyDateFilter').value); }

function updateHistoryUI(filterDate = null) {
  const container = document.getElementById('historyContent');
  let grandTotal = 0, cashT = 0, cardT = 0;
  const filteredSales = filterDate ? sales.filter(s => s.dateKey === filterDate) : sales;
  
  container.innerHTML = filteredSales.length ? '' : '<p style="text-align:center; color:#ccc; padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
  
  filteredSales.forEach(s => {
    grandTotal += s.total;
    if(s.payment === 'cash') cashT += s.total; else cardT += s.total;
    const icon = s.payment === 'cash' ? 'üíµ' : 'üí≥';
    container.innerHTML += `
      <div style="padding:8px 0; border-bottom:1px solid #eee; font-size:12px;">
        <div style="display:flex; justify-content:space-between"><b>${icon} ${s.name}</b> <b>${s.total} ÷è</b></div>
        <div style="color:#999">${s.dateDisplay} ${s.time} ‚Ä¢ ${s.qty} —à—Ç.</div>
      </div>`;
  });
  
  document.getElementById('historyTotal').innerText = grandTotal;
  document.getElementById('totalCash').innerText = cashT;
  document.getElementById('totalCard').innerText = cardT;
}

// –û–¢–ß–ï–¢–´
function sendWhatsAppReport() {
  const filterDate = document.getElementById('historyDateFilter').value;
  const filtered = filterDate ? sales.filter(s => s.dateKey === filterDate) : sales;
  if(!filtered.length) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
  let text = `üì¶ –û—Ç—á–µ—Ç George's (${filterDate || '–í—Å–µ –≤—Ä–µ–º—è'})\n\n`;
  let total = 0;
  filtered.forEach(s => {
    text += `${s.payment === 'cash' ? 'üíµ' : 'üí≥'} ${s.name}: ${s.qty}—à—Ç = ${s.total}÷è\n`;
    total += s.total;
  });
  text += `\nüí∞ –ò–¢–û–ì–û: ${total} ÷è`;
  window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function exportToExcel() {
  const data = sales.map(s => ({"–î–∞—Ç–∞": s.dateDisplay, "–¢–æ–≤–∞—Ä": s.name, "–ö–æ–ª-–≤–æ": s.qty, "–°—É–º–º–∞": s.total, "–¢–∏–ø": s.payment}));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sales");
  XLSX.writeFile(wb, "Report.xlsx");
}

function clearSalesHistory() {
  if(confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂?')) {
    sales = [];
    saveAll();
    updateHistoryUI();
  }
}

function deleteItem(idx) { if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã?')) { items.splice(idx, 1); saveAll(); render(); } }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

document.getElementById('itemForm').onsubmit = e => {
  e.preventDefault();
  items.push({
    name: document.getElementById('name').value,
    quantity: parseInt(document.getElementById('quantity').value),
    price: parseInt(document.getElementById('price').value) || 0
  });
  saveAll(); render(); e.target.reset();
};

render();
</script>
</body>
</html>